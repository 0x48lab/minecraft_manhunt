# Minecraft Manhunt プラグイン仕様書

## 概要
Minecraft Manhuntは、複数のプレイヤーがハンター（追う人）とランナー（逃げる人）に分かれて行う対戦型ゲームプラグインです。

## ゲーム目標
- **ランナー（逃げる人）**: エンダードラゴンを倒すことで勝利
- **ハンター（追う人）**: ランナーを全員倒すことで勝利

## ゲーム開始時のスポーン配置
- **動的スポーン範囲**: プレイヤー総数に応じて自動調整
  - 2人: 半径500m範囲内
  - 20人: 半径2000m範囲内
  - 20人以上: 20人ごとに500m追加で拡大
- **配置ルール**: 
  - 中心点から指定範囲内にランダム配置
  - 安全な地形（地上）に配置
  - プレイヤー間の最小距離を確保

## プレイヤー役割

### PlayerRole（役割）
1. **RUNNER（逃げる人）**
   - エンダードラゴン討伐が目標
   - ハンターに追跡される
   - 近接警告システムで危険を通知

2. **HUNTER（追う人）**
   - ランナーを追跡・討伐が目標
   - 追跡コンパスでランナーの位置を把握

3. **SPECTATOR（観戦者）**
   - ゲームには参加せず観戦のみ
   - ゲーム進行中は自動的にSpectatorモードに設定

## ゲーム状態管理

### GameState（ゲーム状態）
- **WAITING**: ゲーム開始待機中
- **STARTING**: ゲーム開始処理中
- **RUNNING**: ゲーム進行中
- **ENDED**: ゲーム終了

## コマンド仕様

### 基本コマンド
- `/manhunt role <runner|hunter|spectator>` - 役割変更（待機中のみ）
- `/manhunt roles` - 役割選択メニューを開く
- `/manhunt compass` - 仮想追跡コンパス有効化（ハンターのみ、ゲーム中のみ）
- `/manhunt status` - ゲーム状況確認
- `/manhunt spectate` - 観戦メニューを開く（観戦者のみ）
- `/manhunt help` - ヘルプ表示
- `/r <メッセージ>` - チームチャット（味方同士のみ、ゲーム中のみ）
- `/pos` - 自分の座標を味方に共有（ゲーム中のみ）
- `/shop` - ショップを開く（ゲーム中のみ）
- `/shop balance` - 所持金確認
- `/buddy <invite|accept|decline|remove|status|help>` - バディーシステム（ゲーム中のみ）

### 管理者コマンド（manhunt.admin権限）
- `/manhunt start` - ゲーム強制開始
- `/manhunt stop` または `/manhunt end` - ゲーム強制終了
- `/manhunt sethunter <プレイヤー>` - 指定プレイヤーをハンターに設定
- `/manhunt setrunner <プレイヤー>` - 指定プレイヤーをランナーに設定
- `/manhunt setspectator <プレイヤー>` - 指定プレイヤーを観戦者に設定
- `/manhunt minplayers [数値]` - 最小プレイヤー数設定・確認
- `/manhunt reload [config|shop|all]` - 設定ファイルをリロード
- `/manhunt ui <toggle|status>` - UI表示制御
- `/manhunt respawntime <プレイヤー> <秒>` - 個別リスポン時間設定
- `/manhunt reset` - ゲーム強制リセット（ゲーム終了後のみ）
- `/manhunt give <プレイヤー> <金額>` - 指定プレイヤーにお金を付与
- `/manhunt validate-messages` - メッセージファイルの整合性チェック
- `/manhunt diagnose` - メッセージシステムの診断情報を出力

## システム機能

### 1. 追跡コンパスシステム
- ハンターが使用可能な**仮想コンパス**システム
- 物理コンパス所持時または空手で右クリックで使用可能
- **ターゲット切り替え**: 右クリックでランナーを順番に切り替え（1/3, 2/3, 3/3...）
- **表示方法**: パーティクル・音響・タイトルで方向と距離を表示
- **追跡条件**: 
  - 同一ワールド内でのみ動作
  - 死亡中のランナーは追跡対象外
- **クールダウン**: 1秒
- **物理コンパス配布**: ゲーム開始時に自動配布（スロット8）
- **ドロップ制御**: 死亡時は自動復元、他人は拾得不可

### 2. 近接警告システム
- ランナーに危険を通知（スコアボードに常時表示）
- チャンク単位での距離計算
  - 1チャンク以内: 赤色警告 ⚠️
  - 2チャンク以内: 橙色警告 ⚠️
  - 3チャンク以内: 黄色警告 ⚠️
- 警告頻度制御: 5秒ごとに更新（スパム防止）

### 3. 自動ゲーム開始
- **自動スタート設定**: config.ymlで有効/無効を切り替え可能（デフォルト: false）
- **開始条件**:
  - 最小プレイヤー数（デフォルト2人）以上
  - ハンターとランナーが最低1人ずつ必要
- **動作**: 自動スタートが有効で条件を満たすと即座にゲーム開始

### 4. ネットワーク切断対応
- ゲーム中の切断プレイヤーの役割を保持
- 再接続時に元の役割で復帰可能
- 意図的な退出は観戦者に変更

### 5. ゲームモード管理
- **ゲーム開始前**: アドベンチャーモード、役割変更アイテム配布
- **ゲーム中**: 
  - ハンター/ランナー: サバイバルモード
  - 観戦者: スペクテイターモード
- **ゲーム終了後**: 5分間スペクテイターモードでリザルト表示
- **リセット後**: 元のゲームモードに復元

### 6. チームチャットシステム
- **コマンド**: `/r <メッセージ>` または `/teamchat <メッセージ>`
- **対象**: 同じ役割のプレイヤーのみ（ハンター同士、ランナー同士）
- **制限**: ゲーム中のみ使用可能、観戦者は使用不可
- **表示形式**: 
  - ハンター: `§c[🗡チーム] プレイヤー名: メッセージ`
  - ランナー: `§a[🏃チーム] プレイヤー名: メッセージ`
- **プライバシー**: 敵チームには見えない秘匿チャット
- **ログ**: サーバーログに記録（管理者確認用）

### 7. 座標共有システム
- **コマンド**: `/pos` または `/position`、`/coords`
- **対象**: 同じ役割のプレイヤーのみ（ハンター同士、ランナー同士）
- **制限**: ゲーム中のみ使用可能、観戦者は使用不可
- **表示形式**:
  - ハンター: `§c[🗡座標] プレイヤー名: X:100 Y:65 Z:-200 (world)`
  - ランナー: `§a[🏃座標] プレイヤー名: X:100 Y:65 Z:-200 (world)`
- **相対座標表示**: 受信者には相対座標も表示
  - 例: `§7  └→ 相対座標: X:+50 Y:-10 Z:+100 (距離: 112m)`
- **ワールド判定**: 別ワールドの場合はその旨を表示
- **プライバシー**: 敵チームには見えない座標情報
- **便利機能**: 送信者には味方の人数も表示

### 8. 役割選択メニューシステム
- **コマンド**: `/manhunt roles`
- **機能**: GUIメニューでの直感的な役割選択
- **表示内容**: 各役割の説明、現在の人数、選択状態
- **制限**: ゲーム開始前のみ使用可能
- **視覚的表示**: アイコンと色分けによる分かりやすいUI

### 9. 観戦メニューシステム
- **コマンド**: `/manhunt spectate`
- **対象**: 観戦者のみ使用可能
- **機能**: 他プレイヤーへの瞬間移動
- **表示情報**: プレイヤー名、役割、体力、ワールド
- **ページング**: 多数のプレイヤーに対応

### 10. 経済・ショップシステム
- **通貨単位**: G（コイン）
- **開始時所持金**: 0G
- **獲得方法**:
  - **ハンター**: ダメージ報酬（5G/ダメージ）、キル報酬（150G）、時間ボーナス（30秒ごとに1.5G）、追跡持続ボーナス（100m以内30秒継続で30G）
  - **ランナー**: 生存ボーナス（30秒ごとに1.5G）、進歩報酬（ネザー200G、要塞300G、エンド500G）、ダイヤモンド収集（25G/個）、逃走成功（100m以上離れて20G）、接近移動ボーナス（スプリント中かつ3チャンク以内で移動時）
- **ショップカテゴリ**: 武器、防具、ツール、消耗品、食料、特殊アイテム
- **購入制限**: アイテム別購入制限、クールダウン、役割制限
- **UI**: カテゴリ別メニュー、所持金表示、購入可否判定

### 11. 多言語対応システム
- **対応言語**: 日本語（ja）、英語（en）
- **設定**: config.ymlで言語設定可能
- **個人設定**: プレイヤー個別の言語設定対応
- **メッセージファイル**: messages/ja.yml、messages/en.yml
- **完全国際化**: UI、ショップ、コマンド、エラーメッセージすべて対応

### 12. ゲーム結果・統計システム
- **詳細統計**: プレイヤー別の戦績、収入、行動履歴
- **MVP選出**: 最も活躍したプレイヤーを自動選出
- **結果表示**: 段階的な結果発表（基本結果→統計→MVP→個人成績）
- **視覚効果**: 花火演出、音響効果、タイトル表示
- **ランキング**: チーム別・個人別ランキング表示

### 13. 名前表示・移動ボーナスシステム
- **名前表示条件**: スプリント中（スニーク解除時）はプレイヤー名が表示される
- **移動ボーナス条件**: 
  - 名前が表示されている状態（スプリント中）
  - 敵が3チャンク以内に存在
  - 移動することでGを獲得
- **戦略的要素**: スニークで名前を隠すか、スプリントして移動ボーナスを狙うかの選択

### 13. バディーシステム
- **コマンド**: `/buddy invite|accept|decline|remove|status|help`
- **機能**: チームメイト同士で1対1のバディー関係を構築
- **相互承認**: 両プレイヤーの同意が必要

### 14. スポーン配置システム
- **動的配置範囲**: プレイヤー総数に応じて自動調整
  - 2人: 最大500メートル
  - 20人: 最大2000メートル
  - 20人以上: 20人ごとに500メートル追加
- **敵対距離**: 敵チーム間の最小距離500メートル
- **チーム人数比に基づく分散**:
  - 少数派チーム: メンバー同士が近くに配置（分散なし）
  - 多数派チーム: 人数比に応じて最大2000メートルまで分散
- **安全配置**: ランナーは地上に配置、危険な場所を回避
- **統計ログ**: 配置結果の詳細情報を出力
- **制限事項**:
  - ゲーム中のみ使用可能
  - 同じ役割（ハンター同士、ランナー同士）のみ
  - 1人1バディーまで
  - 観戦者は使用不可
- **スコアボード表示**: バディーの名前と相対座標をリアルタイム表示
- **Tabリスト表示**: バディーはオレンジ色で表示（通常の味方は役割に応じた色）
- **自動解除**: ゲーム終了時、プレイヤー退出時に自動的に関係解除


## 勝利条件

### ランナー勝利
- エンダードラゴンを倒した場合
- ハンターが全員退出した場合

### ハンター勝利
- ランナーを全員倒した場合
- ランナーが全員退出した場合

## 設定ファイル（config.yml）

### 言語設定
```yaml
language:
  default: "en"                    # デフォルト言語（ja: 日本語, en: 英語）
  per-player: true                 # プレイヤー個別言語設定
```

### ゲーム設定
```yaml
game:
  min-players: 2                    # 最小プレイヤー数
  auto-start: false                 # 自動スタート有効/無効
  proximity-warning:
    level-1: 1                      # 1チャンク警告
    level-2: 2                      # 2チャンク警告
    level-3: 3                      # 3チャンク警告
    cooldown-seconds: 5             # 警告頻度制御（秒）
  compass-update-interval: 1        # コンパス更新間隔（秒）
  proximity-check-interval: 1       # 近接チェック間隔（秒）
  start-countdown: 10               # ゲーム開始カウントダウン（秒）
  respawn:
    runner-respawn-time: 300        # ランナーリスポン時間（秒）
    hunter-instant-respawn: true    # ハンター即座リスポン
  spawn:
    min-radius: 100                 # スポーン最小半径（メートル）
    max-radius: 2000                # スポーン最大半径（メートル）
    enemy-min-distance: 500         # 敵チーム間の最小距離（メートル）
    team-spread:
      enabled: true                 # チーム分散機能の有効化
      low-threshold: 1.0            # 少数派チームの閾値
      medium-threshold: 1.5         # 中程度分散の閾値
      high-threshold: 2.0           # 最大分散の閾値
      low-distance: 0               # 少数派の分散距離（0=分散なし）
      medium-distance: 1000         # 中程度の分散距離（メートル）
      high-distance: 2000           # 最大分散距離（メートル）
```

### 経済設定
```yaml
economy:
  starting-balance: 0               # 開始時所持金
  max-balance: 999999              # 最大所持金
  currency-unit: "G"               # 通貨単位
  hunter:
    damage-reward: 5               # ダメージ報酬（1ダメージあたり）
    kill-reward: 150               # キル報酬
    time-bonus: 0.05               # 時間ボーナス（1秒あたり）
    time-bonus-interval: 30        # 時間ボーナス間隔（秒）
    tracking-reward: 30            # 追跡持続ボーナス
    tracking-distance: 100         # 追跡持続ボーナスの距離（メートル）
    tracking-duration: 30          # 追跡持続に必要な時間（秒）
    tracking-cooldown: 60          # 追跡持続ボーナスのクールダウン（秒）
  runner:
    survival-bonus: 0.05           # 生存ボーナス（1秒あたり）
    survival-interval: 30          # 生存ボーナス間隔（秒）
    nether-reward: 200             # ネザー到達報酬
    fortress-reward: 300           # 要塞発見報酬
    end-reward: 500                # エンド到達報酬
    diamond-reward: 25             # ダイヤモンド収集報酬（1個あたり）
    escape-reward: 20              # 逃走成功ボーナス
    escape-distance: 100           # 逃走成功距離（メートル）
```

### UI設定
```yaml
ui:
  scoreboard-enabled: true          # スコアボード表示
  actionbar-enabled: true           # ActionBar表示
  bossbar-enabled: true             # BossBar表示
  title-enabled: true               # タイトル表示
  scoreboard-update-interval: 1     # スコアボード更新間隔（秒）
  actionbar-update-interval: 2      # ActionBar更新間隔（秒）
  distance-display:
    minimum-distance: 5             # 最小距離表示（メートル）
```

### メッセージ設定
- **ファイル構成**: messages/ja.yml、messages/en.yml
- **階層構造**: ネストしたキーでメッセージを分類管理
- **プレースホルダー**: `{key}`形式でパラメータ置換対応
- **完全多言語化**: 全システムメッセージを言語別に管理

## クラス構成

### Core Classes
- `Main.kt` - プラグインメインクラス
- `GameManager.kt` - ゲーム状態・プレイヤー管理
- `CompassTracker.kt` - コンパス追跡システム
- `EventListener.kt` - イベント処理
- `ManhuntCommand.kt` - メインコマンド処理
- `ShopCommand.kt` - ショップコマンド処理
- `TeamChatCommand.kt` - チームチャットコマンド処理
- `PositionCommand.kt` - 座標共有コマンド処理

### Manager Classes
- `ConfigManager.kt` - 設定ファイル管理
- `MessageManager.kt` - 多言語メッセージ管理
- `UIManager.kt` - UI表示システム管理
- `GameResultManager.kt` - ゲーム結果・統計管理
- `EconomyManager.kt` - 経済システム管理
- `ShopManager.kt` - ショップシステム管理
- `CurrencyTracker.kt` - 通貨獲得追跡

### Shop System Classes
- `ShopConfigManager.kt` - ショップ設定管理
- `ShopCategory.kt` - ショップカテゴリ管理
- `ShopItem.kt` - ショップアイテム定義
- `ShopGUI.kt` - ショップGUI管理

### Statistics Classes
- `GameStats.kt` - ゲーム統計データ
- `PlayerStatistics.kt` - プレイヤー統計
- `EarnReason.kt` - 通貨獲得理由管理

### Data Classes
- `GameState.kt` - ゲーム状態列挙型
- `PlayerRole.kt` - プレイヤー役割列挙型・データクラス

## 権限設定
- `manhunt.admin` - 管理者権限（デフォルト: OP）
- `manhunt.use` - 基本使用権限（デフォルト: true）

## 技術仕様
- **対応バージョン**: Minecraft 1.21.4
- **プラットフォーム**: Spigot/Paper
- **言語**: Kotlin 1.9.24
- **ビルドツール**: Gradle 8.8
- **JVM**: Java 21

## 死亡・リスポンルール

### ハンター（追う人）の死亡
- **即座リスポン**: 死亡後1tick（約0.05秒）で自動リスポン
- **ゲームモード**: サバイバルモードを維持
- **制限**: リスポン回数制限なし
- **メッセージ**: 「[ハンター] リスポンしました！追跡を続けてください。」

### ランナー（逃げる人）の死亡
- **リスポン待機時間**: 設定可能（デフォルト300秒）
- **待機中の状態**:
  - 1秒後に自動的にスペクテーターモードに変更
  - ゲーム全体を自由に観戦可能
  - 飛行モードで制限なく移動
  - リアルタイムカウントダウン表示（タイトル）
- **リスポン時の処理**:
  - 自動的にサバイバルモードに復帰
  - 元の場所または安全な場所にリスポン
  - 「[ランナー] リスポンしました！エンダードラゴンを倒してください。」

### 勝利条件への影響
- **ハンター勝利**: 全ランナーが死亡した瞬間に即座にゲーム終了
- **ランナー勝利**: エンダードラゴンを倒した場合、または全ハンターが退出した場合
- **即座終了**: リスポン待ち時間に関係なく、生存ランナーが0人になった時点で終了

### UI表示
- **スコアボード**: 「リスポン待ち: X人」表示
- **カウントダウン**: 「💀 死亡中 - X秒後にリスポン」
- **音響効果**: 最後の3秒間でカウントダウン音
- **視覚強調**: 残り3秒で「3...」「2...」「1...」表示

## UI・表示システム

### サイドバー（スコアボード）表示

#### ゲーム開始前
```
🏃 MANHUNT

状態: 待機中

🗡 ハンター: 2
🏃 ランナー: 3  
👁 観戦者: 1


/manhunt help
でコマンド確認
```

#### ゲーム開始後（通常）
```
🏃 MANHUNT

状態: 進行中

🗡 ハンター生存: 2
💀 ハンター死亡: 0
🏃 ランナー生存: 2
💀 ランナー死亡: 1

💰 : 150G

━━━━━━━━━━━━━
/manhunt help
でコマンド確認
```

#### ゲーム開始後（バディーがいる場合）
```
🏃 MANHUNT

状態: 進行中

🗡 ハンター生存: 2
💀 ハンター死亡: 0
🏃 ランナー生存: 2
💀 ランナー死亡: 1

💰 : 150G

━━━━━━━━━━━━━
🤝 バディー: PlayerName
X:+15 Y:-3 Z:+42
```

### Tabキー（プレイヤーリスト）表示

#### 表示対象
- **味方同士のみ**: 同じ役割のプレイヤーのみ表示（観戦者以外）
- **自分**: 常に表示
- **敵・観戦者**: 非表示

#### 表示形式（名前の色のみ、アイコンなし）
- **自分**: 自分の役割に応じた色（ハンター:赤、ランナー:青）
- **バディー**: オレンジ色
- **その他の味方**: 役割に応じた色（ハンター:赤、ランナー:青）
- **観戦者**: 灰色

#### 色の意味
- **赤色**: ハンター
- **青色**: ランナー
- **オレンジ色**: 自分のバディー
- **灰色**: 観戦者

### ActionBar表示
- **ハンター**: 「🗡 ハンターモード | 最寄りターゲット: [名前] ([距離]m)」
- **ランナー**: 「🏃 ランナーモード | エンダードラゴンを倒そう！」
- **観戦者**: 「👁 観戦モード | ゲームを観戦中...」
- **コンパスヒント**: コンパス所持時に「§e§lコンパス右クリックでランナーを追跡」

### 距離表示システム
- **ハンター専用**: コンパス使用時のターゲットとの距離を表示
- **ターゲット切り替え**: 「§b[1/3] §6プレイヤー名 §7- 50m」形式
- **ランナー**: ハンターの距離は**非表示**（ゲームバランス調整）
- **最小距離設定**: 設定値未満の距離は設定値で表示（デフォルト5m）

### 近接警告システム
- **対象**: ランナーのみ
- **警告レベル**: 1・2・3チャンク以内の段階的警告
- **頻度制御**: 同じプレイヤーへの警告は設定秒数間隔（デフォルト5秒）
- **目的**: 警告スパムを防止し、快適なゲームプレイを提供

## 実装の基本ルール

### 多言語対応
- **必須要件**: 文言は英語と日本語の両方を準備すること
- **実装方法**: 
  - 設定ファイル（config.yml）で言語切り替え可能
  - メッセージファイルを言語別に管理（messages/ja.yml、messages/en.yml）
  - プレイヤー個別の言語設定対応
  - デフォルトは英語（config.yml language.default: "en"）
- **完全国際化**: UI、ショップアイテム、コマンド応答、エラーメッセージ全て対応
- **ショップ国際化**: shop.ymlはゲームデータのみ、表示名・説明は言語ファイルで管理

### コーディング規約
- Kotlinのコーディング規約に従う
- メソッド名・変数名は英語
- コメントは日本語可

## 注意事項
- ゲーム進行中の新規ログインプレイヤーは自動的に観戦者モードになります
- ゲーム終了後は5分間のリザルト表示期間があり、その後自動的にリセットされます
- 管理者は`/manhunt reset`で強制リセット可能
- 同一ワールド内でのみ追跡機能が動作します
- リスポン待ち中のランナーは完全に観戦可能で、ゲームの流れを把握できます
- **仮想コンパス**: 物理コンパスまたは空手で右クリックで追跡可能
- **ショップアイテム**: プレイヤーごとにインベントリ表示の有無を設定可能
- **味方連携**: Tabキーで味方の相対座標をリアルタイム表示
- **お金**: ゲーム開始時にリセット（0Gから開始）